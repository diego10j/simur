<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="rep_abastecimiento_general" language="groovy" pageWidth="842" pageHeight="595" orientation="Landscape" columnWidth="842" leftMargin="0" rightMargin="0" topMargin="20" bottomMargin="0" uuid="bfc4e1b9-049c-44f8-a2a0-fbc6473a020d">
	<property name="ireport.zoom" value="0.75"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<parameter name="anio" class="java.lang.String"/>
	<parameter name="mes" class="java.lang.String"/>
	<parameter name="periodo" class="java.lang.String"/>
	<parameter name="tipo" class="java.lang.String"/>
	<parameter name="SUBREPORT_DIR" class="java.lang.String"/>
	<parameter name="tipo_desc" class="java.lang.String"/>
	<queryString>
		<![CDATA[select mve_placa||' / '||
mve_codigo as placa,descripcion,galones,total,recorrido,valor_mantenimiento from
(select y.*,
(case when a.galones is null then '0' when a.galones is not null then a.galones end) as galones,
(case when b.total is null then '0' when b.total is not null then b.total end) as total,
(case when c.kilometros is null then '0' when c.kilometros is not null then c.kilometros end) as recorrido,
(case when d.mantenimiento is null then '0' when d.mantenimiento is not null then d.mantenimiento end) as valor_mantenimiento from
(SELECT v.mve_placa,
v.mve_codigo,
m.mvmarca_descripcion||' / '||
o.mvmodelo_descripcion as descripcion
FROM mv_vehiculo v
INNER JOIN mvmarca_vehiculo m ON v.mvmarca_id = m.mvmarca_id
INNER JOIN mvmodelo_vehiculo o ON v.mvmodelo_id = o.mvmodelo_id
order by v.mve_placa,v.mve_codigo) as y
left join
(select round(sum(cast(a.abastecimiento_galones as NUMERIC)),2) as galones,(case when v.mve_placa is NULL then v.mve_codigo when v.mve_placa is not null then v.mve_placa end ) as placa
FROM mvabactecimiento_combustible a
INNER JOIN mv_vehiculo v ON a.mve_secuencial = v.mve_secuencial
where a.abastecimiento_anio = $P{anio} and a.abastecimiento_periodo =$P{periodo} and a.abastecimiento_tipo_ingreso =$P{tipo}
GROUP BY v.mve_placa,v.mve_codigo) as a
on (case when y.mve_placa is NULL then y.mve_codigo when y.mve_placa is not null then y.mve_placa end )=a.placa
left join
(select round(sum(abastecimiento_total),2) as total,(case when v.mve_placa is NULL then v.mve_codigo when v.mve_placa is not null then v.mve_placa end ) as placa
FROM mvabactecimiento_combustible a
INNER JOIN mv_vehiculo v ON a.mve_secuencial = v.mve_secuencial
where a.abastecimiento_anio = $P{anio} and a.abastecimiento_periodo =$P{periodo} and a.abastecimiento_tipo_ingreso =$P{tipo}
GROUP BY v.mve_placa,v.mve_codigo) as b
on (case when y.mve_placa is NULL then y.mve_codigo when y.mve_placa is not null then y.mve_placa end )=b.placa
left join
(select * from
(select z.*,
(case when a.recorrido is null then cast(substring(b.recorrido,0,5) as numeric) when a.recorrido is not null then (cast(b.recorrido as numeric)-cast(a.recorrido as numeric)) end)
 as kilometros
from
(select (case when v.mve_placa is NULL then v.mve_codigo when v.mve_placa is not null then v.mve_placa end ) as placa
FROM mvabactecimiento_combustible a
INNER JOIN mv_vehiculo v ON a.mve_secuencial = v.mve_secuencial
where a.abastecimiento_anio = $P{anio} and a.abastecimiento_periodo =$P{periodo} and a.abastecimiento_tipo_ingreso =$P{tipo}
GROUP BY v.mve_placa,v.mve_codigo) as z
left join
(select
(case when a.abastecimiento_tipo_ingreso =$P{tipo} then round(min(a.abastecimiento_kilometraje),2) end) as recorrido
,(case when v.mve_placa is NULL then v.mve_codigo when v.mve_placa is not null then v.mve_placa end ) as placa
FROM mvabactecimiento_combustible a
INNER JOIN mv_vehiculo v ON a.mve_secuencial = v.mve_secuencial
where a.abastecimiento_anio = $P{anio} and a.abastecimiento_periodo =$P{periodo} and a.abastecimiento_tipo_ingreso =$P{tipo}
GROUP BY v.mve_placa,v.mve_codigo,a.abastecimiento_tipo_ingreso) as a
on z.placa=a.placa
left JOIN
(select
(case when max(a.abastecimiento_kilometraje) is null then max(a.abastecimiento_horasto)
when max(a.abastecimiento_kilometraje) is not null then cast(round(max(a.abastecimiento_kilometraje),2)as varchar) end )as recorrido
,(case when v.mve_placa is NULL then v.mve_codigo when v.mve_placa is not null then v.mve_placa end ) as placa
FROM mvabactecimiento_combustible a
INNER JOIN mv_vehiculo v ON a.mve_secuencial = v.mve_secuencial
where a.abastecimiento_anio = $P{anio} and a.abastecimiento_periodo =$P{periodo} and a.abastecimiento_tipo_ingreso =$P{tipo}
GROUP BY v.mve_placa,v.mve_codigo)as b
on z.placa=b.placa
) as p
order by placa) as c
on (case when y.mve_placa is NULL then y.mve_codigo when y.mve_placa is not null then y.mve_placa end )=c.placa
left join
(SELECT round(sum(cast(d.mde_total as NUMERIC)),2)
as mantenimiento,(case when v.mve_placa is NULL then v.mve_codigo when v.mve_placa is not null then v.mve_placa end ) as placa
FROM mvdetalle_mantenimiento d
INNER JOIN mvcab_mantenimiento c ON d.mca_codigo = c.mca_codigo
INNER JOIN mv_vehiculo v ON c.mve_secuencial = v.mve_secuencial
where c.mca_anio = $P{anio} and c.mca_periodo = $P{periodo}
and c.mca_tipo_registro =$P{tipo}
GROUP BY v.mve_placa,v.mve_codigo) as d
on (case when y.mve_placa is NULL then y.mve_codigo when y.mve_placa is not null then y.mve_placa end )=d.placa
) as x
where galones >0 and total>0 and recorrido >0 or valor_mantenimiento>0
order by mve_placa,mve_codigo]]>
	</queryString>
	<field name="placa" class="java.lang.String"/>
	<field name="descripcion" class="java.lang.String"/>
	<field name="galones" class="java.math.BigDecimal"/>
	<field name="total" class="java.math.BigDecimal"/>
	<field name="recorrido" class="java.math.BigDecimal"/>
	<field name="valor_mantenimiento" class="java.math.BigDecimal"/>
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band height="30" splitType="Stretch">
			<staticText>
				<reportElement uuid="3256ba55-f6d6-4e22-970f-b6c42321cfa1" key="staticText" x="16" y="0" width="266" height="30" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Left">
					<font size="10" isBold="true" pdfFontName="Helvetica-Bold"/>
				</textElement>
				<text><![CDATA[GOBIERNO AUTÓNOMO DESCENTRALIZADO MUNICIPAL DEL CANTON RUMIÑAHUI]]></text>
			</staticText>
			<staticText>
				<reportElement uuid="d6fd16aa-f6bd-48b4-a653-16e9e0e6fa68" key="staticText" x="610" y="0" width="175" height="20" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Left">
					<font size="10" isBold="true" pdfFontName="Helvetica-Bold"/>
				</textElement>
				<text><![CDATA[ABASTECIMIENTO GENERAL]]></text>
			</staticText>
			<textField>
				<reportElement uuid="6c67bcbc-4482-4c3b-b6c9-54c892b0139b" x="610" y="10" width="107" height="20"/>
				<textElement>
					<font size="10" isBold="true"/>
				</textElement>
				<textFieldExpression><![CDATA[$P{tipo_desc}]]></textFieldExpression>
			</textField>
		</band>
	</title>
	<pageFooter>
		<band height="14" splitType="Stretch">
			<textField evaluationTime="Report" pattern="" isBlankWhenNull="false">
				<reportElement uuid="0c1d6612-570f-4807-a41f-db53c2a0644f" key="textField" x="744" y="0" width="36" height="14" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement>
					<font size="10"/>
				</textElement>
				<textFieldExpression><![CDATA["" + $V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
			<textField pattern="" isBlankWhenNull="false">
				<reportElement uuid="21d592dc-6341-45ef-a32b-da2b0dde6aa3" key="textField" x="574" y="0" width="170" height="14" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Right">
					<font size="10"/>
				</textElement>
				<textFieldExpression><![CDATA["Página " + $V{PAGE_NUMBER} + " de "]]></textFieldExpression>
			</textField>
			<textField pattern="" isBlankWhenNull="false">
				<reportElement uuid="94b84553-d451-49a2-b6ea-f168c201e3b8" key="textField-5" x="17" y="0" width="115" height="14" forecolor="#000000" backcolor="#FFFFFF"/>
				<box>
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement>
					<font size="10"/>
				</textElement>
				<textFieldExpression><![CDATA[new Date()]]></textFieldExpression>
			</textField>
		</band>
	</pageFooter>
	<summary>
		<band height="517" splitType="Stretch">
			<bar3DChart>
				<chart>
					<reportElement uuid="aca4d0c1-7310-4fdc-b35b-14e62e253997" x="0" y="12" width="842" height="505"/>
					<chartTitle/>
					<chartSubtitle/>
					<chartLegend/>
				</chart>
				<categoryDataset>
					<categorySeries>
						<seriesExpression><![CDATA["Total Com."]]></seriesExpression>
						<categoryExpression><![CDATA[$F{placa}+$F{descripcion}]]></categoryExpression>
						<valueExpression><![CDATA[$F{total}]]></valueExpression>
					</categorySeries>
					<categorySeries>
						<seriesExpression><![CDATA["Galones"]]></seriesExpression>
						<categoryExpression><![CDATA[$F{placa}+$F{descripcion}]]></categoryExpression>
						<valueExpression><![CDATA[$F{galones}]]></valueExpression>
					</categorySeries>
				</categoryDataset>
				<bar3DPlot>
					<plot orientation="Horizontal"/>
					<itemLabel/>
					<categoryAxisFormat>
						<axisFormat/>
					</categoryAxisFormat>
					<valueAxisFormat>
						<axisFormat/>
					</valueAxisFormat>
				</bar3DPlot>
			</bar3DChart>
			<textField>
				<reportElement uuid="77c10773-ed3b-4fe6-ae21-e2f995756678" x="444" y="0" width="100" height="13"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression><![CDATA[$P{anio}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement uuid="985d45cd-44dd-43dd-a309-38adbe04a1c4" x="374" y="0" width="100" height="13"/>
				<textElement>
					<font size="8"/>
				</textElement>
				<textFieldExpression><![CDATA[$P{mes}]]></textFieldExpression>
			</textField>
		</band>
	</summary>
</jasperReport>
